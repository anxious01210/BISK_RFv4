{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Lunch — Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <style>
      body {
          background: #0b0b0b;
          color: #ddd;
          font-family: system-ui, sans-serif;
      }

      .sticky-head {
          position: sticky;
          top: 0;
          background: #111;
          color: #fff;
          padding: 10px;
          z-index: 10;
      }

      .badge {
          padding: 2px 8px;
          border-radius: 9999px;
          font-size: 12px;
          color: #fff;
      }

      .g {
          background: #16a34a
      }

      .r {
          background: #dc2626
      }

      .photo {
          width: 44px;
          height: 44px;
          object-fit: cover;
          border-radius: 6px;
      }

      table {
          width: 100%;
          border-collapse: collapse;
      }

      th, td {
          padding: 8px;
          border-bottom: 1px solid #333;
          vertical-align: middle;
      }

      th {
          text-align: start;
      }

      .small {
          font-size: 12px;
          opacity: .8;
      }
      /* Center label text vertically beside its control in the toolbar */
      .sticky-head .small label {
          display: inline-flex;
          align-items: center;
          gap: 6px;
      }

      /* --- Lunch photo previews --- */
      .photos {
          display: flex;
          gap: 6px;
          align-items: center;
      }

      .ph {
          position: relative;
          display: inline-block;
      }

      .ph .open {
          position: absolute;
          right: 4px;
          top: 4px;
          text-decoration: none;
          background: rgba(0, 0, 0, .55);
          color: #fff;
          font-size: 12px;
          line-height: 1;
          padding: 3px 5px;
          border-radius: 4px;
          opacity: .0;
          transition: opacity .15s;
      }

      .ph:hover .open {
          opacity: 1;
      }

      .photo {
          width: 54px;
          height: 54px;
          object-fit: cover;
          border-radius: 6px;
      }

      .ph-empty {
          width: 54px;
          height: 54px;
          border-radius: 6px;
          background: #333;
      }

      /* --- Image modal --- */
      .img-modal[hidden] {
          display: none;
      }

      .img-modal {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, .75);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
      }

      .img-modal .inner {
          position: relative;
          max-width: min(90vw, 1100px);
          max-height: 90vh;
          background: #111;
          padding: 14px;
          border-radius: 10px;
      }

      .img-modal img {
          max-width: 86vw;
          max-height: 80vh;
          display: block;
          margin: 0 auto;
          border-radius: 8px;
      }

      .img-modal .open {
          position: absolute;
          right: 42px;
          top: 10px;
          text-decoration: none;
          background: rgba(255, 255, 255, .12);
          color: #fff;
          padding: 6px 8px;
          border-radius: 6px;
      }

      .img-modal .close-modal {
          position: absolute;
          right: 10px;
          top: 10px;
          border: 0;
          background: rgba(255, 255, 255, .12);
          color: #fff;
          width: 32px;
          height: 32px;
          border-radius: 6px;
          font-size: 18px;
          cursor: pointer;
      }

      .k {
          opacity: .65;
          margin-right: 4px;
      }
  </style>
</head>
<body>

<div class="sticky-head">
  <strong>Lunch — Live</strong>
  <span id="live-counts" class="small" style="margin-left:8px;"></span>
  <div class="small" style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <label>Mode
      <select id="modeSel">
        <option value="latest">Latest per student (live)</option>
        <option value="all_live">All records (live)</option>
        <option value="all_paged">All records (paged)</option>
      </select>
    </label>

    <label>Periods
      <select id="periodSel" multiple size="2">

      </select>
    </label>

    <label>Camera
      <input id="cameraInp" placeholder="Dept_01,Dept_02" style="width:160px;">
    </label>

    <label>Eligible only
      <input id="eligibleChk" type="checkbox">
    </label>

    <label>Min score
      <input id="minScore" type="number" step="0.01" min="0" max="1" style="width:80px;">
    </label>

    <label>Since
      <select id="sinceSel">
        <option value="today" selected>Today</option>
        <option value="15m">Last 15m</option>
        <option value="1h">Last 1h</option>
      </select>
    </label>

    <label id="poll-wrap">Poll
      <select id="poll">
        <option value="500">0.5s</option>
        <option value="1000">1s</option>
        <option value="2000" selected>2s</option>
        <option value="3000">3s</option>
        <option value="5000">5s</option>
        <option value="10000">10s</option>
        <option value="15000">15s</option>
        <option value="30000">30s</option>
        <option value="60000">60s</option>
        <option value="0">Paused</option>
      </select>
    </label>

    <label id="pagesize-wrap" style="display:none">Page size
      <select id="page_size">
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>7</option>
        <option>10</option>
        <option style="font-weight: bold;" selected>20</option>
        <option>30</option>
        <option>40</option>
        <option>50</option>
        <option>70</option>
        <option>100</option>
      </select>
    </label>

    <span id="pager" style="display:none; gap:8px; align-items:center;">
  <button id="page_prev" type="button">◀ Prev</button>
  <span id="page_info">Page 1</span>
  <button id="page_next" type="button">Next ▶</button>
</span>


    <button id="resetBtn" type="button"
            title="Restart live stream from the current 'Since' filter. Only applies in mode 'Latest per student (live)'.">
      Reset cursor
    </button>
    <span id="spinner" class="small" style="display:none;margin-left:10px;">Loading…</span>
  </div>

  <audio id="ding" preload="auto">
    <source src="{% static 'attendance/ding.mp3' %}" type="audio/mpeg">
  </audio>
</div>

<form id="params">
  <input type="hidden" name="mode" id="mode_input" value="latest">
  <input type="hidden" name="last_n" id="last_n" value="">
  <input type="hidden" name="period" id="period" value="{{ default_periods }}">
  <input type="hidden" name="camera" id="camera" value="{{ default_cameras }}">
  <input type="hidden" name="eligible_only" id="eligible_only" value="">
  <input type="hidden" name="min_score" id="min_score" value="">
  <input type="hidden" name="q" id="q" value="">
  <input type="hidden" name="date_from" id="date_from" value="">
  <input type="hidden" name="date_to" id="date_to" value="">
  <input type="hidden" name="after_ts" id="after_ts" value="">
  <input type="hidden" name="page" id="page" value="1">
  <input type="hidden" name="page_size" id="page_size_input" value="20">
</form>

{% if show_empty_notice %}
  <div class="notice"
       style="margin:8px 0; padding:8px; background:#fff8db; border:1px solid #f1e8a8; border-radius:6px;">
    No PeriodTemplates/Cameras tagged with <b>lunch</b>. Set tags in Admin and reload.
  </div>
{% endif %}

<table>
  <thead>
  <tr>
    <th>Photos</th>
    <th>Student</th>
    <th>Period</th>
    <th>Camera</th>
    <th>Eligible</th>
    <th>Confirm</th>
    <th>Pass</th>
    <th>Score</th>
    <th>Times</th>
    <th>Last pass</th>
  </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<!-- HTMX driver -->
<div id="lunch-driver"
     hx-get="{% url 'attendance:lunch_stream_rows' %}"
  {#     hx-trigger="load, refresh, every 2s"#}
     hx-trigger="refresh"
     hx-include="#params"
     hx-target="#rows"
     hx-swap="innerHTML"
     hx-indicator="#spinner"></div>


<script>
  (function () {
    // ---------- tiny DOM helpers ----------
    const $ = (id) => document.getElementById(id);

    // elements we use a lot
    const driver = $('lunch-driver');
    const rowsBody = $('rows');
    const liveCnt = $('live-counts');

    // toolbar controls
    const modeSel = $('modeSel');          // visible mode select
    const modeInput = $('mode_input');       // hidden <input name="mode">
    const lastN = $('last_n');

    const periodSel = $('periodSel');
    const cameraInp = $('cameraInp');
    const eligible = $('eligibleChk');
    const minScore = $('minScore');
    const sinceSel = $('sinceSel');
    const pollSel = $('poll');             // NOTE: id="poll"
    const resetBtn = $('resetBtn');

    // paging controls
    const pageSizeWrap = $('pagesize-wrap');
    const pageSizeSel = $('page_size');
    const pageSizeInp = $('page_size_input');
    const pageInp = $('page');
    const pager = $('pager');
    const pageInfo = $('page_info');
    const prevBtn = $('page_prev');
    const nextBtn = $('page_next');

    // hidden params
    const periodInp = $('period');
    const cameraHid = $('camera');
    const eligHid = $('eligible_only');
    const minScoreHid = $('min_score');
    const dateFromHid = $('date_from');
    const dateToHid = $('date_to');
    const afterTsHid = $('after_ts');

    // ----- CSRF for HTMX -----
    document.body.addEventListener('htmx:configRequest', (evt) => {
      const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
      if (m) evt.detail.headers['X-CSRFToken'] = decodeURIComponent(m[1]);
    });

// ---- hydrate Periods/Cameras from defaults and sync hidden inputs ----
    (function hydrateFromDefaults() {
      // hidden inputs already populated by the view
      const defaultsPeriods = (document.getElementById("period").value || "")
        .split(",").map(s => s.trim()).filter(Boolean);
      const defaultsCameras = (document.getElementById("camera").value || "")
        .split(",").map(s => s.trim()).filter(Boolean);

      // Build Period options, select all, and set size = N (min 2 to keep UI tidy)
      const sel = document.getElementById("periodSel");
      sel.innerHTML = "";
      defaultsPeriods.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        opt.selected = true;     // auto-select all
        sel.appendChild(opt);
      });
      sel.size = Math.max(2, defaultsPeriods.length || 2);

      // If you want the visible camera input prefilled too:
      const cameraInp = document.getElementById("cameraInp");
      if (cameraInp && defaultsCameras.length) {
        cameraInp.value = defaultsCameras.join(",");
      }

      // DEBUG (optional): see what we hydrated
      console.groupCollapsed("[lunch] hydrateFromDefaults");
      console.log("periods:", defaultsPeriods);
      console.log("cameras:", defaultsCameras);
      console.groupEnd();

      // Keep hidden inputs in sync with the visible controls
      const periodHid = document.getElementById("period");
      sel.addEventListener("change", () => {
        const vals = Array.from(sel.options).filter(o => o.selected).map(o => o.value);
        periodHid.value = vals.join(",");
        htmx.trigger(document.getElementById("lunch-driver"), "refresh");
      });

      const cameraHid = document.getElementById("camera");
      if (cameraInp) {
        cameraInp.addEventListener("change", () => {
          cameraHid.value = (cameraInp.value || "")
            .split(",").map(s => s.trim()).filter(Boolean).join(",");
          htmx.trigger(document.getElementById("lunch-driver"), "refresh");
        });
      }

      // Kick an initial load using these hydrated values
      htmx.trigger(document.getElementById("lunch-driver"), "refresh");
    })();


    // ---------- filter updaters ----------
    function isoTodayStart() {
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).toISOString();
    }

    function isoSinceMinutes(min) {
      return new Date(Date.now() - min * 60 * 1000).toISOString();
    }

    function updateSince() {
      const v = sinceSel.value;
      dateFromHid.value =
        v === 'today' ? isoTodayStart() :
          v === '15m' ? isoSinceMinutes(15) :
            isoSinceMinutes(60);
    }

    function updatePeriods() {
      const vals = Array.from(periodSel.selectedOptions).map(o => o.value);
      periodInp.value = vals.join(',');
    }

    function updateEligible() {
      eligHid.value = eligible.checked ? '1' : '';
    }

    function updateCamera() {
      cameraHid.value = (cameraInp.value || '').trim();
    }

    function updateMinScore() {
      minScoreHid.value = (minScore.value || '').trim();
    }

    function resetCursor() {
      afterTsHid.value = '';
    }

    // ---------- persistence for page size ----------
    const LS_KEY = 'lunch.page_size';
    const savedSize = localStorage.getItem(LS_KEY);
    if (savedSize && [...pageSizeSel.options].some(o => o.value === savedSize)) {
      pageSizeSel.value = savedSize;
      pageSizeInp.value = savedSize;
    }

    // ---------- mode & paging controller (single source of truth) ----------
    const pollTriggerStr = () => {
      const ms = parseInt(pollSel.value || '2000', 10) || 0;
      return ms > 0 ? `load, refresh, every ${Math.max(1, Math.round(ms / 1000))}s` : 'load, refresh';
    };
    {#const isPaged = (m) => m === 'all_paged' || m.startsWith('last');#}
    const isPaged = (m) => m === 'all_paged';
    {#const lastNFromMode = (m) => m.startsWith('last') ? (parseInt(m.replace('last', ''), 10) || '') : '';#}
    const isAllLive = (m) => m === 'all_live';

    function setDriver(trigger, swap) {
      driver.setAttribute('hx-trigger', trigger);
      driver.setAttribute('hx-swap', swap); // always replace tbody
      htmx.process(driver);  // rebind with the new trigger/swap
    }

    function resetPage() {
      pageInp.value = '1';
      pageInfo.textContent = 'Page 1';
      prevBtn.disabled = true;
      nextBtn.disabled = false;
    }

    function applyMode() {
      const m = modeSel.value;

      // server expects: latest | all | lastN
      // map client "all_live" to server "all"
      {#modeInput.value = (m === 'all_paged' || isAllLive(m)) ? 'all' : (m.startsWith('last') ? 'lastN' : 'latest')#}
      modeInput.value = (m === 'all_paged' || isAllLive(m)) ? 'all' : 'latest';
      {#lastN.value = lastNFromMode(m);#}
      lastN.value = ""; // not used anymore

      const paged = isPaged(m);

      // toggle controls
      // show poll when live modes are active
      $('poll-wrap').style.display = (m === 'latest' || isAllLive(m)) ? '' : 'none';
      // page size is useful for paged AND all_live (acts as “latest N”)
      pageSizeWrap.style.display = (paged || isAllLive(m)) ? '' : 'none';
      // no manual pager for all_live (always page 1)
      pager.style.display = paged ? 'inline-flex' : 'none';

      // driver policy
      if (m === 'latest' || isAllLive(m)) {
        // live polling
        setDriver(pollTriggerStr(), 'innerHTML');
        if (isAllLive(m)) {
          // all_live always shows newest page (page 1)
          pageInp.value = '1';
        }
      } else {
        // paged/manual modes
        setDriver('load, refresh', 'innerHTML');
        resetCursor();
      }

      resetPage();
      htmx.trigger(driver, 'refresh');
    }

    // ---------- events (filters) ----------
    periodSel.addEventListener('change', () => {
      updatePeriods();
      resetCursor();
      htmx.trigger(driver, 'refresh');
    });
    eligible.addEventListener('change', () => {
      updateEligible();
      resetCursor();
      htmx.trigger(driver, 'refresh');
    });
    cameraInp.addEventListener('change', () => {
      updateCamera();
      resetCursor();
      htmx.trigger(driver, 'refresh');
    });
    minScore.addEventListener('change', () => {
      updateMinScore();
      resetCursor();
      htmx.trigger(driver, 'refresh');
    });
    sinceSel.addEventListener('change', () => {
      updateSince();
      resetCursor();
      htmx.trigger(driver, 'refresh');
    });

    // mode & poll & paging events
    modeSel.addEventListener('change', applyMode);
    pollSel.addEventListener('change', () => {
      if (modeSel.value === 'latest' || modeSel.value === 'all_live') {
        setDriver(pollTriggerStr(), 'innerHTML');
        if (modeSel.value === 'all_live') pageInp.value = '1';
        htmx.trigger(driver, 'refresh');
      }
    });
    pageSizeSel.addEventListener('change', () => {
      pageSizeInp.value = pageSizeSel.value;
      localStorage.setItem(LS_KEY, pageSizeSel.value);
      resetPage();
      htmx.trigger(driver, 'refresh');
    });
    prevBtn.addEventListener('click', () => {
      const cur = Math.max(1, (parseInt(pageInp.value, 10) || 1) - 1);
      pageInp.value = String(cur);
      pageInfo.textContent = `Page ${cur}`;
      htmx.trigger(driver, 'refresh');
    });
    nextBtn.addEventListener('click', () => {
      const cur = (parseInt(pageInp.value, 10) || 1) + 1;
      pageInp.value = String(cur);
      pageInfo.textContent = `Page ${cur}`;
      htmx.trigger(driver, 'refresh');
    });
    resetBtn.addEventListener('click', () => {
      resetCursor();
      htmx.trigger(driver, 'refresh');
    });

    // ---------- first-time init (order matters!) ----------
    document.addEventListener('DOMContentLoaded', () => {
      // hydrate visible controls from hidden defaults provided by the server
      // periods: select options that match #period's comma list
      const defaultPeriods = (periodInp.value || '').split(',').filter(Boolean);
      Array.from(periodSel.options).forEach(o => {
        o.selected = defaultPeriods.includes(o.value);
      });
      // camera: show the default list (if any) in the textbox so change events keep it
      if (cameraHid.value) cameraInp.value = cameraHid.value;

      // set all hidden params BEFORE the very first fetch
      updateSince();
      updatePeriods();   // now reflects server-tagged defaults (or empty if none)
      updateEligible();
      updateCamera();    // keeps defaults if set above
      updateMinScore();

      // let the controller configure the driver & make the first request
      applyMode();
    });

    // ---------- after rows arrive ----------
    document.body.addEventListener('htmx:afterSwap', (evt) => {
      if (evt.target !== rowsBody) return;

      // live count
      liveCnt.textContent = `${rowsBody.querySelectorAll('tr').length} row(s)`;

      // only advance cursor in "latest" mode
      if (modeSel.value === 'latest') {
        const trig = evt.detail.xhr.getResponseHeader('HX-Trigger');
        if (trig) {
          try {
            const data = JSON.parse(trig);
            if (data['lunch:last_ts']) afterTsHid.value = data['lunch:last_ts'];
          } catch {
          }
        } else {
          afterTsHid.value = new Date().toISOString();
        }
        // (optional) ding on arrivals
        const audio = $('ding');
        audio && audio.play && audio.play().catch(() => {
        });
      }

      // keep newest page when live-all mode
      if (modeSel.value === 'all_live') {
        pageInp.value = '1';
      }
    });

    // ---------- update pager from server totals ----------
    document.body.addEventListener('htmx:afterOnLoad', (evt) => {
      if (evt.target !== driver) return;
      const trig = evt.detail.xhr.getResponseHeader('HX-Trigger');
      if (!trig) return;
      try {
        const data = JSON.parse(trig);
        if (data['lunch:page'] && data['lunch:pages']) {
          const p = data['lunch:page'], P = data['lunch:pages'];
          pageInfo.textContent = `Page ${p} of ${P}`;
          prevBtn.disabled = (p <= 1);
          nextBtn.disabled = (p >= P);
        }
      } catch {
      }
    });

    // ---------- thumbnail preview modal (unchanged) ----------
    function modalEls() {
      return {modal: $('img-modal'), img: $('img-modal-img'), open: $('img-modal-open')};
    }

    document.addEventListener('click', (e) => {
      const t = e.target.closest('.js-preview');
      if (t) {
        const {modal, img, open} = modalEls();
        if (!modal) return;
        const src = t.dataset.full || t.getAttribute('src');
        img.src = src;
        open.href = src;
        modal.hidden = false;
        return;
      }
      if (e.target.closest('.close-modal')) {
        const {modal, img} = modalEls();
        if (modal) modal.hidden = true;
        if (img) img.src = '';
      }
      const {modal, img} = modalEls();
      if (modal && e.target === modal) {
        modal.hidden = true;
        if (img) img.src = '';
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const {modal, img} = modalEls();
        if (modal && !modal.hidden) {
          modal.hidden = true;
          if (img) img.src = '';
        }
      }
    });
  })();
</script>

<!-- Image preview modal -->
<div id="img-modal" class="img-modal" hidden>
  <div class="inner">
    <a id="img-modal-open" class="open" href="#" target="_blank" title="Open original">↗</a>
    <button class="close-modal" aria-label="Close">×</button>
    <img id="img-modal-img" alt="">
  </div>
  <!-- click outside inner to close -->
</div>
</body>
</html>
