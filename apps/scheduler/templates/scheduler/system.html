{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
    <meta charset="utf-8">
    <title>BISK System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        /* --- Minimal page chrome for the standalone dash --- */
        :root {
            color-scheme: light dark;
        }

        body {
            margin: 0;
            padding: 0 10px 24px;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: #fff;
        }

        html[data-theme="dark"] body,
        html[data-theme="system"] body {
            background: #0b0f16;
        }

        .dash-wrap {
            max-width: 1200px;
            margin: 16px auto;
        }

        /* --- Theme toggle --- */
        .theme-toggle {
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            justify-content: flex-end;
            padding: 10px 0 6px;
        }

        .theme-toggle .group {
            display: inline-flex;
            background: rgba(0, 0, 0, .04);
            border: 1px solid #d1d5db;
            border-radius: 10px;
            overflow: hidden;
        }

        .theme-toggle button {
            appearance: none;
            border: 0;
            background: transparent;
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            color: #0f172a;
        }

        .theme-toggle button.active {
            background: #eef2ff;
            color: #1e3a8a;
        }

        .theme-toggle button:not(.active):hover {
            background: rgba(0, 0, 0, .05);
        }

        /* dark/system look */
        html[data-theme="dark"] .theme-toggle .group,
        html[data-theme="system"] .theme-toggle .group {
            background: rgba(255, 255, 255, .06);
            border-color: rgba(255, 255, 255, .18);
        }

        html[data-theme="dark"] .theme-toggle button,
        html[data-theme="system"] .theme-toggle button {
            color: #e5e7eb;
        }

        html[data-theme="dark"] .theme-toggle button.active,
        html[data-theme="system"] .theme-toggle button.active {
            background: #111827;
            color: #ffffff;
        }

        html[data-theme="dark"] .theme-toggle button:not(.active):hover,
        html[data-theme="system"] .theme-toggle button:not(.active):hover {
            background: rgba(255, 255, 255, .08);
        }

        /* Optional: page title */
        .dash-title {
            font-size: 22px;
            font-weight: 800;
            margin: 8px 0 2px;
            color: #0f172a;
        }

        html[data-theme="dark"] .dash-title,
        html[data-theme="system"] .dash-title {
            color: #f1f5f9;
        }
    </style>
</head>
<script src="https://unpkg.com/htmx.org@1.9.12"></script>

<body>
<div class="dash-wrap">
    <!-- Theme toggle (dash only) -->
    <div class="theme-toggle" aria-label="Theme">
        <div class="group" role="tablist" aria-label="Theme">
            <button id="tLight" type="button" role="tab" aria-selected="false">Light</button>
            <button id="tSystem" type="button" role="tab" aria-selected="true" class="active">System</button>
            <button id="tDark" type="button" role="tab" aria-selected="false">Dark</button>
        </div>
    </div>

    {#    {% include "scheduler/_system_panel.html" %}#}
    <div id="system-panel"
         hx-get="{% url 'system_panel_partial' %}"
         hx-trigger="load, every {{ auto_refresh|default:10 }}s"
         hx-swap="innerHTML">
        {# initial render: keep the current content so first paint is instant #}
        {% include "scheduler/_system_panel.html" %}
    </div>

</div>

<script>
    (function () {
        // IDs used inside the panel
        const INPUT_ID = 'biskRefreshInput';
        const BADGE_ID = 'biskRefreshCountdown';
        const PANEL_ID = 'system-panel';
        const LS_KEY = 'bisk:system:auto_refresh_seconds';

        const panel = document.getElementById(PANEL_ID);

        // Read persisted value (default 30s), clamp 0..86400
        function loadSeconds() {
            const raw = localStorage.getItem(LS_KEY);
            const n = raw == null ? 30 : parseInt(raw, 10);
            return (isNaN(n) || n < 0) ? 0 : Math.min(n, 86400);
        }

        // Apply polling interval to HTMX
        function applyHtmxInterval(seconds) {
            const trig = seconds ? `load, every ${seconds}s` : 'load';
            panel.setAttribute('hx-trigger', trig);
        }

        // Countdown state
        let seconds = loadSeconds();
        let timer = null;
        let left = seconds;

        // On-demand element getters (important after HTMX swaps)
        function $input() {
            return document.getElementById(INPUT_ID);
        }

        function $badge() {
            return document.getElementById(BADGE_ID);
        }

        function paint() {
            const b = $badge();
            if (!b) return;
            b.textContent = seconds ? (left + 's') : 'off';
        }

        function stop() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        function start() {
            stop();
            left = seconds || 0;
            paint();
            if (!seconds) return; // off
            timer = setInterval(() => {
                left = Math.max(0, left - 1);
                paint();
            }, 1000);
        }

        // (Re)bind the input listener â€” call this after each HTMX swap
        function bindInput() {
            const inp = $input();
            if (!inp) return;
            // Reflect current value into the input
            inp.value = String(seconds);
            // Remove any old listener by replacing the node (cheap way to avoid duplicates)
            const clone = inp.cloneNode(true);
            inp.parentNode.replaceChild(clone, inp);
            clone.addEventListener('change', () => {
                let n = parseInt(clone.value, 10);
                if (isNaN(n) || n < 0) n = 0;
                if (n > 86400) n = 86400;
                seconds = n;
                localStorage.setItem(LS_KEY, String(seconds));
                applyHtmxInterval(seconds);
                start();
            });
        }

        // Initial apply + bind
        applyHtmxInterval(seconds);
        bindInput();
        start();

        // After HTMX swaps the panel, re-bind and restart the countdown
        document.body.addEventListener('htmx:afterSwap', (evt) => {
            if (evt.target && evt.target.id === PANEL_ID) {
                bindInput();
                start();
            }
        });

        // Pause when tab hidden; resume when visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) stop(); else start();
        });
    })();
</script>


</body>
</html>
