{% load humanize %}

<style>
    /* ---------------- Theme tokens ---------------- */
    .bisk {
        --bisk-text: #0f172a; /* slate-900 */
        --bisk-muted: #475569; /* slate-600 */
        --bisk-border: #d1d5db; /* gray-300 */
        --bisk-surface: #ffffff; /* white */
        --bisk-chip: #f3f4f6; /* gray-100 */
        --bisk-surface-soft: #f9fafb; /* gray-50 */

        --bisk-btn-bg: #eef2ff; /* indigo-50-ish */
        --bisk-btn-border: #c7d2fe; /* indigo-200 */
        --bisk-btn-text: #1e3a8a; /* indigo-800 */
        --bisk-btn-bg-hover: #e0e7ff;
        --bisk-btn-border-hover: #a5b4fc;
        --bisk-btn-text-hover: #1e3a8a;
    }

    html.dark .bisk,
    body.dark .bisk,
    html[data-theme="dark"] .bisk,
    body[data-theme="dark"] .bisk {
        --bisk-text: #e5e7eb;
        --bisk-muted: #cbd5e1;
        --bisk-border: rgba(255, 255, 255, .16);
        --bisk-surface: rgba(255, 255, 255, .06);
        --bisk-chip: rgba(255, 255, 255, .12);
        --bisk-surface-soft: rgba(255, 255, 255, .08);

        --bisk-btn-bg: #0b1220;
        --bisk-btn-border: #334155;
        --bisk-btn-text: #e5e7eb;
        --bisk-btn-bg-hover: #111827;
        --bisk-btn-border-hover: #3f4a5a;
        --bisk-btn-text-hover: #ffffff;
    }

    @media (prefers-color-scheme: dark) {
        html[data-theme="system"] .bisk,
        body[data-theme="system"] .bisk,
        html[data-theme="auto"] .bisk,
        body[data-theme="auto"] .bisk {
            --bisk-text: #e5e7eb;
            --bisk-muted: #cbd5e1;
            --bisk-border: rgba(255, 255, 255, .16);
            --bisk-surface: rgba(255, 255, 255, .06);
            --bisk-chip: rgba(255, 255, 255, .12);
            --bisk-surface-soft: rgba(255, 255, 255, .08);

            --bisk-btn-bg: #0b1220;
            --bisk-btn-border: #334155;
            --bisk-btn-text: #e5e7eb;
            --bisk-btn-bg-hover: #111827;
            --bisk-btn-border-hover: #3f4a5a;
            --bisk-btn-text-hover: #ffffff;
        }
    }

    /* ---------------- Layout & components ---------------- */
    .bisk {
        color: var(--bisk-text);
        font-size: 14px;
        line-height: 1.45;
    }

    .bisk a {
        color: inherit;
        text-decoration: none;
    }

    .bisk-grid {
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        gap: 12px;
        margin: 8px 0 4px;
    }

    .bisk-card {
        grid-column: span 12;
        background: var(--bisk-surface);
        border: 1px solid var(--bisk-border);
        border-radius: 10px;
        padding: 12px;
    }

    @media (min-width: 900px) {
        .bisk-col-4 {
            grid-column: span 4
        }

        .bisk-col-6 {
            grid-column: span 6
        }

        .bisk-col-8 {
            grid-column: span 8
        }

        .bisk-col-12 {
            grid-column: span 12
        }
    }

    .bisk-h {
        font-weight: 700;
        margin: 0 0 10px
    }

    .bisk-h-lg {
        font-size: 16px
    }

    html.dark .bisk .bisk-h-lg,
    body.dark .bisk .bisk-h-lg,
    html[data-theme="dark"] .bisk .bisk-h-lg,
    body[data-theme="dark"] .bisk .bisk-h-lg,
    html[data-theme="system"] .bisk .bisk-h-lg,
    body[data-theme="system"] .bisk .bisk-h-lg,
    html[data-theme="auto"] .bisk .bisk-h-lg,
    body[data-theme="auto"] .bisk .bisk-h-lg {
        color: #f8fafc;
    }

    .bisk-kv {
        display: grid;
        grid-template-columns:180px 1fr;
        row-gap: 8px;
        column-gap: 10px
    }

    .bisk-badges {
        display: flex;
        gap: 6px;
        flex-wrap: wrap
    }

    .bisk-badge {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 2px 8px;
        border: 1px solid var(--bisk-border);
        background: var(--bisk-chip);
        font-size: 12px
    }

    .bisk-badge.red {
        background: #fee2e2;
        border-color: #fecaca;
        color: #991b1b
    }

    .bisk-badge.green {
        background: #dcfce7;
        border-color: #bbf7d0;
        color: #065f46
    }

    .bisk-badge.yellow {
        background: #fef9c3;
        border-color: #fde68a;
        color: #78350f
    }

    html.dark .bisk .bisk-badge.red,
    body.dark .bisk .bisk-badge.red,
    html[data-theme="dark"] .bisk .bisk-badge.red,
    body[data-theme="dark"] .bisk .bisk-badge.red,
    html[data-theme="system"] .bisk .bisk-badge.red,
    body[data-theme="system"] .bisk .bisk-badge.red,
    html[data-theme="auto"] .bisk .bisk-badge.red,
    body[data-theme="auto"] .bisk .bisk-badge.red {
        background: rgba(220, 38, 38, .16);
        border-color: rgba(220, 38, 38, .35);
        color: #fca5a5;
    }

    html.dark .bisk .bisk-badge.green,
    body.dark .bisk .bisk-badge.green,
    html[data-theme="dark"] .bisk .bisk-badge.green,
    body[data-theme="dark"] .bisk .bisk-badge.green,
    html[data-theme="system"] .bisk .bisk-badge.green,
    body[data-theme="system"] .bisk .bisk-badge.green,
    html[data-theme="auto"] .bisk .bisk-badge.green,
    body[data-theme="auto"] .bisk .bisk-badge.green {
        background: rgba(16, 185, 129, .16);
        border-color: rgba(16, 185, 129, .35);
        color: #86efac;
    }

    html.dark .bisk .bisk-badge.yellow,
    body.dark .bisk .bisk-badge.yellow,
    html[data-theme="dark"] .bisk .bisk-badge.yellow,
    body[data-theme="dark"] .bisk .bisk-badge.yellow,
    html[data-theme="system"] .bisk .bisk-badge.yellow,
    body[data-theme="system"] .bisk .bisk-badge.yellow,
    html[data-theme="auto"] .bisk .bisk-badge.yellow,
    body[data-theme="auto"] .bisk .bisk-badge.yellow {
        background: rgba(234, 179, 8, .16);
        border-color: rgba(234, 179, 8, .35);
        color: #fde68a;
    }

    .bisk-mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
    }

    .bisk-toprow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 6px 0 12px
    }

    .bisk-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap
    }

    /* Button */
    .bisk-btn {
        appearance: none;
        border: 1px solid var(--bisk-btn-border);
        background: var(--bisk-btn-bg);
        color: var(--bisk-btn-text);
        border-radius: 10px;
        padding: 6px 12px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color .15s ease, border-color .15s ease, transform .12s ease, box-shadow .15s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, .06);
    }

    .bisk-btn:hover {
        background: var(--bisk-btn-bg-hover);
        border-color: var(--bisk-btn-border-hover);
        color: var(--bisk-btn-text-hover);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, .10);
    }

    .bisk-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, .06);
    }

    /* Auto-refresh control */
    .bisk-refresh {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--bisk-muted);
        background: var(--bisk-chip);
        border: 1px solid var(--bisk-border);
        border-radius: 8px;
        padding: 4px 8px;
    }

    .bisk-input {
        width: 90px;
        padding: 4px 6px;
        font-size: 12px;
        border-radius: 6px;
        border: 1px solid var(--bisk-border);
        background: var(--bisk-surface);
        color: var(--bisk-text);
    }

    .bisk-sub {
        color: var(--bisk-muted);
        font-size: 12px
    }

    html.dark .bisk .bisk-sub,
    body.dark .bisk .bisk-sub,
    html[data-theme="dark"] .bisk .bisk-sub,
    body[data-theme="dark"] .bisk .bisk-sub,
    html[data-theme="system"] .bisk .bisk-sub,
    body[data-theme="system"] .bisk .bisk-sub,
    html[data-theme="auto"] .bisk .bisk-sub,
    body[data-theme="auto"] .bisk .bisk-sub {
        color: #cbd5e1;
    }

    .bisk-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 6px;
        font-size: 13px
    }

    .bisk-table th {
        color: var(--bisk-muted);
        font-weight: 600;
        text-align: left;
        padding: 6px 8px;
        background: var(--bisk-surface-soft);
        border-top: 1px solid var(--bisk-border);
        border-bottom: 1px solid var(--bisk-border)
    }

    .bisk-table td {
        background: var(--bisk-surface);
        border-top: 1px solid var(--bisk-border);
        border-bottom: 1px solid var(--bisk-border);
        padding: 8px 8px
    }

    .bisk-muted {
        color: var(--bisk-muted)
    }
</style>

<div class="bisk">
    <div class="bisk-toprow">
        <div>
            {% if host_name %}
                <div class="bisk-h bisk-h-lg">BISK System — {{ host_name }}</div>
            {% else %}
                <div class="bisk-h bisk-h-lg">System overview</div>
            {% endif %}
            <div class="bisk-sub">Updated {{ now }}</div>
        </div>
        <div class="bisk-actions">
            <!-- Auto-refresh control -->
            <label class="bisk-refresh" title="Set auto-refresh interval in seconds (0 = off)">
                <span>Auto-refresh (s)</span>
                <input id="biskRefreshInput" class="bisk-input" type="number" min="0" max="86400" step="1"/>
                <span id="biskRefreshCountdown" class="bisk-sub">off</span>
            </label>

            <!-- Enforce now -->
            <form method="post" action="{% url 'enforce_now' %}">
                {% csrf_token %}
                <button type="submit" class="bisk-btn">Enforce now</button>
            </form>
        </div>
    </div>

    <div class="bisk-grid">
        <!-- Host -->
        <div class="bisk-card bisk-col-6">
            <div class="bisk-h">Host</div>
            <div class="bisk-kv">
                <div>CPU</div>
                <div>{{ cpu_percent|floatformat:1 }}%</div>

                <div>Load (1/5/15m)</div>
                <div>
                    {% if load.0 %}
                        {{ load.0|floatformat:2 }} / {{ load.1|floatformat:2 }} / {{ load.2|floatformat:2 }}
                    {% else %}
                        <span class="bisk-muted">n/a</span>
                    {% endif %}
                </div>

                <div>RAM</div>
                <div>{{ ram.used|intcomma }} / {{ ram.total|intcomma }} ({{ ram.percent }}%)</div>

                <div>Disk /</div>
                <div>{{ disk.used|intcomma }} / {{ disk.total|intcomma }} ({{ disk.percent }}%)</div>
            </div>
        </div>

        <!-- Runners summary -->
        <div class="bisk-card bisk-col-6">
            <div class="bisk-h">Runners</div>
            <div class="bisk-badges">
                <span class="bisk-badge green">Online: <span class="bisk-mono"
                                                             style="margin-left:6px">{{ runners.online }}</span></span>
                <span class="bisk-badge yellow">Stale: <span class="bisk-mono"
                                                             style="margin-left:6px">{{ runners.stale }}</span></span>
                <span class="bisk-badge red">Offline: <span class="bisk-mono"
                                                            style="margin-left:6px">{{ runners.offline }}</span></span>
                <span class="bisk-badge">Paused: <span class="bisk-mono"
                                                       style="margin-left:6px">{{ paused }}</span></span>
            </div>
        </div>
        <!-- Runner Heartbeats -->
        <div class="bisk-card bisk-col-12">
            <div class="bisk-h">Runner Heartbeats</div>

            {% if runner_rows %}
                <div style="max-height: 360px; overflow: auto;">
                    <table class="bisk-table">
                        <thead>
                        <tr>
                            <th>Runner</th>
                            <th>PID</th>
                            <th class="text-end">Target FPS</th>
                            <th class="text-end">Camera FPS</th>
                            <th class="text-end">Processed FPS</th>
                            <th class="text-end">Snapshot (s)</th>
                            <th class="text-end">Last HB</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for r in runner_rows %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">{{ r.label }}</div>
                                    {% if r.status %}
                                        <div class="bisk-sub">Status: {{ r.status }}</div>{% endif %}
                                </td>
                                <td class="bisk-mono">{% if r.pid %}{{ r.pid }}{% else %}—{% endif %}</td>

                                <td class="text-end">
                                    {% if r.target_fps is not None %}
                                        {{ r.target_fps|floatformat:1 }}
                                    {% else %}<span class="bisk-muted">—</span>{% endif %}
                                </td>

                                <td class="text-end">
                                    {% if r.camera_fps is not None %}
                                        {{ r.camera_fps|floatformat:1 }}
                                    {% else %}<span class="bisk-muted">—</span>{% endif %}
                                </td>

                                <td class="text-end">
                                    {% if r.processed_fps is not None %}
                                        {{ r.processed_fps|floatformat:1 }}
                                    {% else %}<span class="bisk-muted">—</span>{% endif %}
                                </td>

                                <td class="text-end">
                                    {% if r.snapshot_every is not None %}
                                        {{ r.snapshot_every }}
                                    {% else %}<span class="bisk-muted">—</span>{% endif %}
                                </td>

                                <td class="text-end">
                                    {% if r.hb_age_s is not None %}
                                        {% with th=hb_thresholds %}
                                            {% if r.hb_age_s <= th.online %}
                                                <span class="bisk-badge green" title="{{ r.hb_ts }}">{{ r.hb_age_s }}s ago</span>
                                            {% elif r.hb_age_s <= th.stale %}
                                                <span class="bisk-badge yellow" title="{{ r.hb_ts }}">{{ r.hb_age_s }}s ago</span>
                                            {% else %}
                                                <span class="bisk-badge red"
                                                      title="{{ r.hb_ts }}">{{ r.hb_age_s }}s ago</span>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <span class="bisk-muted">—</span>
                                    {% endif %}

                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="bisk-muted">No runner heartbeats yet.</div>
            {% endif %}
        </div>


        <!-- Enforcer -->
        <div class="bisk-card bisk-col-12">
            <div class="bisk-h">Enforcer</div>
            <table class="bisk-table">
                <thead>
                <tr>
                    <th>Interval</th>
                    <th>PID</th>
                    <th>Last run</th>
                    <th>Last OK</th>
                    <th>Last error</th>
                    <th class="bisk-muted">Keys</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td class="bisk-mono">{{ enforcer.interval }}s</td>
                    <td class="bisk-mono">{% if enforcer.pid %}{{ enforcer.pid }}{% else %}—{% endif %}</td>
                    <td>{% if enforcer.last_run %}{{ enforcer.last_run }}{% else %}
                        <span class="bisk-muted">—</span>{% endif %}</td>
                    <td>{% if enforcer.last_ok %}{{ enforcer.last_ok }}{% else %}
                        <span class="bisk-muted">—</span>{% endif %}</td>
                    <td>
                        {% if enforcer.last_error %}
                            <span class="bisk-badge red"
                                  title="{{ enforcer.last_error }}">{{ enforcer.last_error }}</span>
                        {% else %}
                            <span class="bisk-muted">—</span>
                        {% endif %}
                    </td>
                    <td class="bisk-muted">enforcer:last_run · :last_ok · :last_error · :running_pid</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- GPU -->
        <div class="bisk-card bisk-col-12">
            <div class="bisk-h">GPU</div>
            {% if gpus %}
                <table class="bisk-table">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Util</th>
                        <th>Memory</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for g in gpus %}
                        <tr>
                            <td>{{ g.name }}</td>
                            <td>{% if g.util is not None %}{{ g.util }}%{% else %}
                                <span class="bisk-muted">n/a</span>{% endif %}</td>
                            <td>
                                {% if g.mem_used is not None %}
                                    {{ g.mem_used }} / {{ g.mem_total }} MiB
                                {% else %}
                                    <span class="bisk-muted">n/a</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="bisk-muted">No GPU detected (nvidia-smi not found or no NVIDIA GPU).</div>
            {% endif %}
        </div>
    </div>
</div>


