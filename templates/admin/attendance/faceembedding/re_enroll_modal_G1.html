{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}{{ block.super }}
  <script defer src="https://unpkg.com/htmx.org@1.9.12"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.body.addEventListener('htmx:configRequest', function (e) {
        const t = document.querySelector('meta[name="csrf-token"]')?.content;
        if (t) e.detail.headers['X-CSRFToken'] = t;
      });
    });
  </script>
{% endblock %}




{% block extrastyle %}
  <style>
      /* reuse admin_chips tokens if loaded; provide fallbacks here */
      :root {
          --bisk-card-bg: #ffffff;
          --bisk-card-br: #e5e7eb;
          --bisk-card-fg: #374151;
          --bisk-badge-br: #cbd5e1;
          --bisk-badge-k: #e0e7ff;
          --bisk-badge-min: #dcfce7;
          --bisk-badge-det: #fef9c3;
          --hairline: #444;
      }

      @media (prefers-color-scheme: dark) {
          :root {
              --bisk-card-bg: #0f172a;
              --bisk-card-br: #334155;
              --bisk-card-fg: #e5e7eb;
              --bisk-badge-br: #334155;
              --bisk-badge-k: #111827;
              --bisk-badge-min: #0b2b1f;
              --bisk-badge-det: #1a1710;
          }
      }

      :root[data-theme="dark"], .theme-dark {
          --bisk-card-bg: #0f172a;
          --bisk-card-br: #334155;
          --bisk-card-fg: #e5e7eb;
          --bisk-badge-br: #334155;
          --bisk-badge-k: #111827;
          --bisk-badge-min: #0b2b1f;
          --bisk-badge-det: #1a1710;
      }

      @media (prefers-color-scheme: light) {
          :root {
              --hairline: #e5e7eb;
          }

          /* lighter hairline in light mode (optional) */
      }

      .bisk-wrap {
          padding: 16px;
      }

      .bisk-badges {
          display: flex;
          gap: 8px;
          margin: 8px 0 16px;
      }

      .badge {
          font-size: 11px;
          padding: 2px 6px;
          border-radius: 10px;
          border: 1px solid var(--bisk-badge-br);
          color: var(--bisk-card-fg);
      }

      .badge.k {
          background: var(--bisk-badge-k);
      }

      .badge.min {
          background: var(--bisk-badge-min);
      }

      .badge.det {
          background: var(--bisk-badge-det);
      }

      .grid {
          display: grid;
          grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));
          gap: 10px;
      }

      /*        */
      .card {
          border: 1px solid var(--bisk-card-br);
          border-radius: 10px;
          padding: 8px;
          background: var(--bisk-card-bg);
          color: var(--bisk-card-fg);
      }

      .meta {
          font-size: 11px;
          margin-top: 6px;
          color: var(--bisk-card-fg);
          line-height: 1.3;
      }

      .thumb {
          width: 100%;
          height: 100px;
          object-fit: cover;
          border-radius: 8px;
          position: relative;
          z-index: 1;
      }

      .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr 1fr 1fr auto;
          gap: 10px;
          align-items: end;
          margin-top: 14px;
      }

      /* file-manager elements */
      .card.sel {
          position: relative;
          cursor: pointer;
      }

      .sel-box {
          position: absolute;
          top: 6px;
          left: 6px;
          width: 18px;
          height: 18px;
          border-radius: 4px;
          border: 1px solid var(--bisk-card-br);
          background: rgba(255, 255, 255, .08);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 2;
          pointer-events: auto; /* so clicks reach the card */
      }

      .card.sel .tick {
          width: 14px;
          height: 14px;
      }

      .sel-box .tick path {
          stroke: transparent !important; /* key: force hidden when not selected */
          stroke-width: 3;
          fill: none;
          transition: stroke .12s ease;
      }

      /* show the blue box + white tick only when selected */
      .card.sel.is-selected .sel-box {
          background: #3b82f6;
          border-color: #3b82f6;
      }

      .card.sel.is-selected .sel-box .tick path {
          stroke: #fff !important;
      }


      /* breadcrumbs */
      .crumbs {
          display: flex;
          align-items: center;
          gap: 10px;
          margin: 6px 0 10px;
      }


      .crumbs .trail {
          font-size: 12px;
          color: var(--bisk-card-fg);
      }

      /* --- Breadcrumb hover/active polish --- */
      .crumbs a {
          cursor: pointer;
          transition: color .15s ease, background-color .15s ease, box-shadow .15s ease, transform .05s ease;
      }

      /* links in the trail */
      .crumbs .crumb {
          color: var(--bisk-card-fg);
          text-decoration: none;
          padding: 2px 6px;
          border-radius: 6px;
      }

      .crumbs .crumb:hover,
      .crumbs .crumb:focus-visible {
          color: #93c5fd; /* blue-300 */
          background: rgba(147, 197, 253, .12);
          text-decoration: none;
          outline: none;
      }

      /* the "← Up" chip */
      .crumbs .up {
          font-size: 12px;
          line-height: 1;
          background: #334155; /* slate-700 */
          color: #fff;
          border-radius: 8px;
          padding: 2px 8px;
          text-decoration: none;
          box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .08);
      }

      .crumbs .up:hover,
      .crumbs .up:focus-visible {
          background: #475569; /* slate-600 */
          box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .18);
          outline: none;
      }

      .crumbs .up:active {
          transform: translateY(1px);
      }

      /* optional: tone down the slash separators a bit */
      .crumbs .sep {
          margin: 0 6px;
          opacity: .55;
      }

      /* filename: force one line with ellipsis */
      .card .meta .fname {
          margin-top: 6px;
          font-weight: 600;
          color: #d7dce3;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .card .meta .stats {
          margin-top: 4px;
          font-size: 11px;
          line-height: 1.1;
          color: #9aa4b2;
      }

      .card.sel.is-selected {
          box-shadow: 0 0 0 2px #3b82f6 inset;
      }

      .success {
          background: #0f5132;
          color: #d1fae5;
          padding: 8px 10px;
          border-radius: 8px;
      }

      .error {
          background: #842029;
          color: #ffe2e6;
          padding: 8px 10px;
          border-radius: 8px;
      }

      .lc-card {
          border: 1px solid rgba(255, 255, 255, .08);
          border-radius: 8px;
          padding: 14px;
          margin: 10px 0 18px;
          background: #0f0f10;
      }

      .lc-row {
          display: grid;
          grid-template-columns:repeat(5, minmax(160px, 1fr));
          gap: 14px;
          margin-bottom: 10px;
      }

      .lc-col {
          display: flex;
          flex-direction: column;
      }

      .lc-input {
          height: 32px;
          padding: 4px 8px;
          border-radius: 6px;
          border: 1px solid rgba(255, 255, 255, .12);
          background: #161617;
          color: #eaeaea;
      }

      .lc-help {
          font-size: 11px;
          opacity: .75;
          margin-top: 4px;
      }

      .lc-check {
          display: flex;
          gap: 8px;
          align-items: center;
      }

      .lc-spacer {
          flex: 1
      }

      @media (max-width: 1200px) {
          .lc-row {
              grid-template-columns:repeat(2, minmax(160px, 1fr));
          }
      }

  </style>
{% endblock %}

{% block content %}
  <div class="bisk-wrap">
    <h2>Re-enroll: {{ student.h_code }}</h2>
    <div class="bisk-badges">
      <span class="badge k">current K: {{ fe.last_used_k|default:"—" }}</span>
      <span class="badge min">min: {{ fe.last_used_min_score|default:"—" }}</span>
      <span class="badge det">det: {{ fe.last_used_det_size|default:"—" }}</span>
    </div>

    {# --- NEW: Captures browser (HTMX) --- #}
    <h3 style="margin:16px 0 8px;font-size:18px;">Captured crops (date / period / camera)</h3>
    <div id="captures-browser"
         hx-get="{{ browser_url }}?score=0"
         hx-trigger="load, bisk:refresh-captures from:body"
         hx-target="#captures-browser"
         hx-swap="innerHTML">
      <div style="opacity:.6">Loading…</div>
    </div>


    {% if rows %}
      <div class="grid">
        {% for r in rows %}
          <div class="card"
               title="{{ r.name }} | score={{ r.score|floatformat:2 }} | sharp={{ r.sharp|floatformat:2 }} | bright=
                 {{ r.bright|floatformat:2 }}{% if r.det_size %} | det={{ r.det_size }}{% endif %}{% if r.det_conf %} | conf={{ r.det_conf|floatformat:2 }}{% endif %}">
            <img class="thumb" src="{{ r.url }}" onerror="this.style.display='none'">
            <div class="meta">
              <div class="fname" title="{{ r.name }}">{{ r.name }}</div>
              <div>score: {{ r.score|floatformat:2 }}</div>
              <div>sharp: {{ r.sharp|floatformat:2 }}</div>
              <div>bright: {{ r.bright|floatformat:2 }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      {#            <p>No images found (or no scorable images) in the student’s gallery.</p>#}
    {% endif %}

    <div style="display:flex; gap:8px; align-items:center; margin:8px 0 14px;">
      {#            <input type="hidden" id="csrf_token" name="csrfmiddlewaretoken" value="{{ csrf_token }}">#}
      <button id="btn-clear" type="button" class="button">Clear selection (Esc)</button>
      <button id="btn-delete" type="button" class="button button-danger"
              hx-post="{{ delete_url }}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}"
              hx-include="#selected_paths"
              hx-target="#captures-browser"
              hx-swap="innerHTML"
              hx-confirm="Delete the selected items?">
        Delete selected
      </button>

    </div>

    {# DELETE selection lives outside the re-enroll form #}
    <input type="hidden" id="selected_paths" name="delete_selected" value="[]">


    {# RE-ENROLL form with its own hidden 'selected' #}
    <form id="reenroll-form" method="post"
          hx-post="{% url 'admin:attendance_faceembedding_re_enroll_run' fe.pk %}"
          hx-target="#reenroll-output" hx-swap="innerHTML">
      {% csrf_token %}
      <input type="hidden" id="selected-input" name="selected" value="[]">
      <div class="form-row">
        <div>
          <label for="id_k">K</label>
          {{ form.k }}
        </div>
        <div>
          <label for="id_det_size">det-size</label>
          {{ form.det_size }}
        </div>
        <div>
          <label for="id_min_score">min-score</label>
          {{ form.min_score }}
        </div>
        <div>
          <label for="id_strict_top">strict-top</label>
          {{ form.strict_top }}
        </div>
        <div>
          <button type="submit" class="button button-primary">Run re-enroll (force)</button>
          <a href="../../" class="button">Close</a>
        </div>
      </div>
    </form>
    <div id="reenroll-output"></div>
    {#        <div id="reenroll-output" style="display:none"></div>#}

  </div>
  <div>
    <!-- How the fields behave when left empty -->
    <details style="margin:10px 0 16px;">
      <summary style="cursor:pointer;font-weight:600;">What happens when fields are empty?</summary>
      <div style="margin-top:10px;font-size:13px;line-height:1.5;">
        <ul style="margin:0 0 0 18px;padding:0;">
          <li><strong>K</strong> — If left blank, the system uses this row’s <code>last_used_k</code>, or
            <strong>3</strong> if that’s empty.
          </li>
          <li><strong>det-size</strong> — If left blank, it keeps the current detector size already set in
            memory (defaults to <strong>640</strong> unless you changed it earlier).
          </li>
          <li><strong>min-score</strong> — Only matters when <em>strict-top</em> is checked.
            <ul style="margin:4px 0 0 18px;">
              <li>When <em>strict-top</em> is <strong>checked</strong> and <em>min-score</em> is blank,
                the view passes <strong>0.00</strong> (accept all), then picks the top-K.
              </li>
              <li>When <em>strict-top</em> is <strong>unchecked</strong>, <em>min-score</em> is
                effectively ignored and the helper uses its own default (your
                <code>EMBEDDING_MIN_SCORE</code> in settings) only for internal scoring; selection is
                simply the top-K.
              </li>
            </ul>
          </li>
          <li><strong>strict-top</strong> — If checked, images with score &lt; min-score are dropped <em>before</em>
            choosing K; if not, the top-K are chosen without a hard cutoff.
          </li>
        </ul>
      </div>
    </details>
    <hr style="margin:24px 0;opacity:.25">

    <h3 style="margin:0 0 12px;">Live capture (FFmpeg)</h3>

    <form id="livecap-form"
          hx-post="{{ capture_url }}"
          hx-target="#captures-browser"
      {#              hx-swap="innerHTML">#}
          hx-swap="none">
      hx-on::after-request="document.body.dispatchEvent(new CustomEvent('bisk:refresh-captures'));">
      {% csrf_token %}
      <div class="lc-card">

        <div class="lc-row">
          <div class="lc-col">
            <label>Camera</label>
            <select name="camera_rtsp" id="lc-camera" class="lc-input">
              <option value="">— use script default —</option>
              {% for cam in cameras %}
                <option value="{{ cam.rtsp_url }}" data-tr="{{ cam.rtsp_transport|default:'auto' }}">
                  {{ cam.name }}{% if cam.location %} — {{ cam.location }}{% endif %}
                </option>
              {% endfor %}
            </select>
            <div class="lc-help">Leave blank to use the script’s default RTSP.</div>
          </div>

          <div class="lc-col">
            <label>Top-K images</label>
            <select id="id_k" name="k">
              {% for n in top_k_options %}
                <option value="{{ n }}"{% if n|stringformat:"s" == selected_top_k %}
                        selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="lc-col">
            <label>det_set</label>
            <select id="id_det_set" name="det_size">
              {% for d in det_set_options %}
                <option value="{{ d }}"{% if d|stringformat:"s" == selected_det_set %}
                        selected{% endif %}>{{ d }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="lc-col">
            <label>Duration (s)</label>
            <input class="lc-input" type="number" name="duration" min="5" step="1" value="30">
          </div>

          <div class="lc-col">
            <label>FPS</label>
            <input class="lc-input" type="number" name="fps" min="1" max="30" step="0.5" value="4">
          </div>
        </div>

        <div class="lc-row">
          <div class="lc-col">
            <label>Crop format</label>
            <select name="crop_fmt" class="lc-input">
              <option value="">inherit</option>
              <option value="jpg" selected>jpg</option>
              <option value="png">png</option>
            </select>
          </div>

          <div class="lc-col">
            <label>JPEG quality</label>
            <input class="lc-input" type="number" name="crop_jpeg_quality" min="50" max="100" step="1"
                   value="92">
          </div>

          <div class="lc-col">
            <label>min_face_px</label>
            <input class="lc-input" type="number" name="min_face_px" placeholder="inherit">
          </div>

          <div class="lc-col">
            <label>BBox expand</label>
            <input class="lc-input" type="number" name="bbox_expand" step="0.05" min="0.0" max="0.8"
                   value="0.0">
            <div class="lc-help">Extra margin around faces (fraction).</div>
          </div>

          <div class="lc-col">
            <label>Model</label>
            <select name="model" class="lc-input">
              <option value="">inherit</option>
              <option value="buffalo_l" selected>buffalo_l</option>
              <option value="antelopev2">antelopev2</option>
            </select>
          </div>
        </div>

        <div class="lc-row">
          <div class="lc-col">
            <label>Qual weights</label>
            <input class="lc-input" name="qual_weights" placeholder="e.g. 0.6,0.3,0.1">
            <div class="lc-help">sharp,bright,size (optional)</div>
          </div>

          <div class="lc-col">
            <label>Pipe MJPEG q</label>
            <input class="lc-input" name="pipe_mjpeg_q" placeholder="inherit">
          </div>

          <div class="lc-col">
            <label>Transport</label>
            <select name="rtsp_transport" id="lc-transport" class="lc-input">
              <option value="auto">auto</option>
              <option value="tcp" selected>tcp</option>
              <option value="udp">udp</option>
            </select>
          </div>

          <div class="lc-col">
            <label>Device</label>
            <select name="device" class="lc-input">
              <option value="auto" selected>auto</option>
              <option value="cpu">cpu</option>
              <option value="cuda:0">cuda:0</option>
            </select>
          </div>

          <div class="lc-col">
            <label>HW accel</label>
            <select name="hwaccel" class="lc-input">
              <option value="none" selected>none</option>
              <option value="nvdec">nvdec</option>
              <option value="vaapi">vaapi</option>
            </select>
          </div>
        </div>

        <div class="lc-row" style="align-items:center;">
          <label class="lc-check">
            <input type="checkbox" name="save_top_crops" value="1" checked> Save top crops
          </label>

          <div class="lc-spacer"></div>

          <button type="submit" class="button" style="margin-top:8px;">Run live capture</button>
        </div>
      </div>
    </form>

    {#        <h3 style="margin:0 0 12px;font-size:18px;">Live capture (FFmpeg)</h3>#}
    {#        <form id="livecap-form"#}
    {#              hx-post="{% url 'admin:attendance_faceembedding_re_enroll_capture_run' fe.pk %}"#}
    {#              hx-post="{{ capture_url }}"#}
    {#              hx-target="#captures-browser"#}
    {#              hx-swap="outerHTML">#}
    {#            {% csrf_token %}#}
    {#            <div class="form-row" style="gap:12px; align-items:flex-end; flex-wrap:wrap">#}
    {##}
    {#                <div>#}
    {#                    <label>Camera</label>#}
    {#                    <input type="text" name="camera_rtsp" placeholder="rtsp://… (optional)" style="width:280px">#}
    {#                    <div class="help">Leave blank to use script defaults.</div>#}
    {#                </div>#}
    {##}
    {#                <label>Top-K images</label>#}
    {#                <select id="id_k" name="k">#}
    {#                    {% for n in top_k_options %}#}
    {#                        <option value="{{ n }}"{% if n|stringformat:"s" == selected_top_k %}#}
    {#                                selected{% endif %}>{{ n }}</option>#}
    {#                    {% endfor %}#}
    {#                </select>#}
    {##}
    {#                <label>det_set</label>#}
    {#                <select id="id_det_set" name="det_size">#}
    {#                    {% for d in det_set_options %}#}
    {#                        <option value="{{ d }}"{% if d|stringformat:"s" == selected_det_set %}#}
    {#                                selected{% endif %}>{{ d }}</option>#}
    {#                    {% endfor %}#}
    {#                </select>#}
    {##}
    {##}
    {#                <div>#}
    {#                    <label>Duration (s)</label>#}
    {#                    <input type="number" name="duration" value="30" min="5" step="5">#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>FPS</label>#}
    {#                    <input type="number" name="fps" value="4" min="0.5" step="0.5">#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>min_face_px</label>#}
    {#                    <input type="number" name="min_face_px" placeholder="inherit" min="20" step="5">#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>Model</label>#}
    {#                    <select name="model">#}
    {#                        <option value="">(inherit)</option>#}
    {#                        <option value="buffalo_l" selected>buffalo_l</option>#}
    {#                        <option value="antelopev2">antelopev2</option>#}
    {#                    </select>#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>Pipe MJPEG q</label>#}
    {#                    <input type="number" name="pipe_mjpeg_q" placeholder="inherit" min="1" max="31">#}
    {#                    <div class="help">1 best … 31 worst</div>#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>Crop format</label>#}
    {#                    <select name="crop_fmt">#}
    {#                        <option value="">(inherit)</option>#}
    {#                        <option value="jpg" selected>jpg</option>#}
    {#                        <option value="png">png</option>#}
    {#                    </select>#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>JPEG quality</label>#}
    {#                    <input type="number" name="crop_jpeg_quality" value="92" min="1" max="100">#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>BBox expand</label>#}
    {#                    <input type="number" name="bbox_expand" value="0.0" step="0.05" min="0" max="0.5">#}
    {#                    <div class="help">Add margin around faces (fraction)</div>#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>Qual weights</label>#}
    {#                    <input type="text" name="qual_weights" placeholder="0.6,0.3,0.1">#}
    {#                    <div class="help">sharp,bright,size</div>#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>Transport</label>#}
    {#                    <select name="rtsp_transport">#}
    {#                        <option value="tcp" selected>tcp</option>#}
    {#                        <option value="udp">udp</option>#}
    {#                        <option value="auto">auto</option>#}
    {#                    </select>#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>Device</label>#}
    {#                    <select name="device">#}
    {#                        <option value="auto" selected>auto</option>#}
    {#                        <option value="cuda">cuda</option>#}
    {#                        <option value="cpu">cpu</option>#}
    {#                    </select>#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <label>HW accel</label>#}
    {#                    <select name="hwaccel">#}
    {#                        <option value="none" selected>none</option>#}
    {#                        <option value="nvdec">nvdec</option>#}
    {#                    </select>#}
    {#                </div>#}
    {##}
    {#                <div style="display:flex; align-items:center; gap:8px; margin-top:4px">#}
    {#                    <label><input type="checkbox" name="save_top_crops" value="1" checked> Save top crops</label>#}
    {#                    <button type="submit" class="button button-primary">Run live capture</button>#}
    {#                </div>#}
    {#            </div>#}
    {#        </form>#}

    {#        <form method="post" action="{{ capture_url }}" style="display:block;margin-bottom:16px;">#}
    {#            {% csrf_token %}#}
    {#            <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">#}
    {#                <div>#}
    {#                    <label style="display:block;font-size:12px;opacity:.8">Camera</label>#}
    {#                    {{ capture_form.camera }}#}
    {#                </div>#}
    {#                <div>#}
    {#                    <label style="display:block;font-size:12px;opacity:.8">Top-K images</label>#}
    {#                    {{ capture_form.k }}#}
    {#                </div>#}
    {#                <div>#}
    {#                    <label style="display:block;font-size:12px;opacity:.8">det_set</label>#}
    {#                    {{ capture_form.det_size }}#}
    {#                </div>#}
    {##}
    {#                <div>#}
    {#                    <button type="submit" class="button" style="margin-top:18px;">Run live capture</button>#}
    {#                </div>#}
    {#            </div>#}
    {##}
    {#            <p style="margin-top:8px;color:#9aa">#}
    {#                Captures a short burst from the selected camera, clusters faces, picks the dominant#}
    {#                person, ranks by quality (sharpness/brightness/size), and averages the top-K into#}
    {#                <code>media/embeddings/{{ fe.student.h_code }}.npy</code>, then activates a new embedding.#}
    {#            </p>#}
    {#        </form>#}

  </div>

  <script>
    /* Re-enroll modal — selection + HTMX glue (single-click, capture phase) */
    (function () {
      const onReady = (fn) =>
        (document.readyState === 'loading')
          ? document.addEventListener('DOMContentLoaded', fn)
          : fn();

      onReady(() => {
        const CONTAINER_ID = 'captures-browser';
        const ROOT = document.getElementById(CONTAINER_ID);
        const H_DELETE = document.getElementById('selected_paths');  // used by Delete
        const H_RUN = document.getElementById('selected-input');  // used by Re-enroll
        const BTN_CLEAR = document.getElementById('btn-clear');
        const FORM = document.getElementById('reenroll-form');

        if (!ROOT) return;

        const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));
        const selectedCards = () => $$('.card.sel.is-selected', ROOT);
        const selectedRels = () => selectedCards().map(c => c.dataset.rel).filter(Boolean);

        function syncHidden() {
          const payload = JSON.stringify(selectedRels());
          if (H_DELETE) H_DELETE.value = payload;
          if (H_RUN) H_RUN.value = payload;
        }

        function clearSelection() {
          selectedCards().forEach(c => c.classList.remove('is-selected'));
          syncHidden();
        }

        // Toggle once on CLICK (capture phase so other handlers can’t swallow it)
        function clickToggle(e) {
          const container = document.getElementById(CONTAINER_ID);
          if (!container || !container.contains(e.target)) return;
          const card = e.target.closest('.card.sel');
          if (!card) return;
          card.classList.toggle('is-selected');
          syncHidden();
        }

        document.addEventListener('click', clickToggle, true); // capture = true

        // Esc clears
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') clearSelection();
        });

        // Clear button
        BTN_CLEAR?.addEventListener('click', clearSelection);

        // Keep hidden fields coherent after HTMX replaces the grid
        document.body.addEventListener('htmx:afterSwap', (evt) => {
          if (evt.target && evt.target.id === CONTAINER_ID) syncHidden();
        });

        // Ensure selection is serialized right before Re-enroll POST
        FORM?.addEventListener('submit', syncHidden);
        document.body.addEventListener('htmx:beforeRequest', (evt) => {
          if (evt.target === FORM) syncHidden();
        });

        // Initial sync
        syncHidden();

        // (Optional) expose a tiny flag so you can confirm it ran:
        window.__REENROLL_WIRED__ = true;
      });
    })();


    /***Start*** --- helpers for feedback / busy state --- ***/
    (function () {
      const FORM = document.getElementById('reenroll-form');
      const BTN_RUN = FORM?.querySelector('button[type="submit"]');
      const BTN_DELETE = document.getElementById('btn-delete');

      // Simple toast
      function showToast(detail) {
        const msg = typeof detail === 'string' ? detail : (detail?.text || JSON.stringify(detail));
        const el = document.createElement('div');
        el.textContent = msg;
        el.style.position = 'fixed';
        el.style.right = '16px';
        el.style.bottom = '16px';
        el.style.padding = '10px 12px';
        el.style.background = '#1f2937';
        el.style.color = '#fff';
        el.style.borderRadius = '10px';
        el.style.boxShadow = '0 6px 30px rgba(0,0,0,.35)';
        el.style.zIndex = '9999';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 7000);
      }

      function setBusy(btn, on, labelBusy) {
        if (!btn) return;
        if (on) {
          btn.dataset._label = btn.textContent;
          btn.textContent = labelBusy || 'Working…';
          btn.setAttribute('disabled', 'disabled');
        } else {
          if (btn.dataset._label) btn.textContent = btn.dataset._label;
          btn.removeAttribute('disabled');
        }
      }

      // Accept server "toast" events
      document.body.addEventListener('toast', (e) => showToast(e.detail));

      // Busy states during HTMX requests
      document.body.addEventListener('htmx:beforeRequest', (e) => {
        if (e.target === FORM) setBusy(BTN_RUN, true, 'Re-enrolling…');
        if (e.target === BTN_DELETE) setBusy(BTN_DELETE, true, 'Deleting…');
      });
      document.body.addEventListener('htmx:afterRequest', (e) => {
        if (e.target === FORM) setBusy(BTN_RUN, false);
        if (e.target === BTN_DELETE) setBusy(BTN_DELETE, false);
      });
    })();
    /***End *** --- helpers for feedback / busy state --- ***/
    // When camera changes, copy its preferred transport into the transport select (if present)
    (function () {
      const camSel = document.getElementById('lc-camera');
      const trSel = document.getElementById('lc-transport');
      if (camSel && trSel) {
        camSel.addEventListener('change', function () {
          const opt = this.options[this.selectedIndex];
          const tr = opt ? (opt.dataset.tr || '') : '';
          if (tr) trSel.value = tr;
        });
      }
    })();
  </script>


{% endblock %}

